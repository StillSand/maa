name: MAA

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ï¼ˆé»˜è®¤ autoï¼‰'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - init
          - update
#  schedule:
#    - cron: '0 5,17 * * *'

env:
  TZ: Asia/Shanghai
  CLIENT_TYPE: Official

jobs:
  maa:
    name: MAA
    runs-on: ubuntu-24.04-arm
    permissions:
      actions: write
      contents: write
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“‹ æ£€æŸ¥é…ç½®çŠ¶æ€
        env:
          CONTAINER_ENCRYPTION_KEY: ${{ secrets.CONTAINER_ENCRYPTION_KEY }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "=========================================="
          echo "ğŸ“‹ ç¯å¢ƒé…ç½®æ£€æŸ¥"
          echo "=========================================="
          echo ""
          echo "ğŸŒ ç¯å¢ƒå˜é‡ï¼š"
          echo "  TZ: ${{ env.TZ }}"
          echo "  CLIENT_TYPE: ${{ env.CLIENT_TYPE }}"
          echo ""
          echo "ğŸ” Secrets é…ç½®çŠ¶æ€ï¼š"
          [ -n "$CONTAINER_ENCRYPTION_KEY" ] && echo "  âœ… CONTAINER_ENCRYPTION_KEY: å·²é…ç½®" || echo "  âŒ CONTAINER_ENCRYPTION_KEY: æœªé…ç½®"
          [ -n "$CLOUDFLARE_TUNNEL_TOKEN" ] && echo "  âœ… CLOUDFLARE_TUNNEL_TOKEN: å·²é…ç½®" || echo "  âš ï¸  CLOUDFLARE_TUNNEL_TOKEN: æœªé…ç½®"
          [ -n "$TELEGRAM_BOT_TOKEN" ] && echo "  âœ… TELEGRAM_BOT_TOKEN: å·²é…ç½®" || echo "  âš ï¸  TELEGRAM_BOT_TOKEN: æœªé…ç½®"
          [ -n "$TELEGRAM_CHAT_ID" ] && echo "  âœ… TELEGRAM_CHAT_ID: å·²é…ç½®" || echo "  âš ï¸  TELEGRAM_CHAT_ID: æœªé…ç½®"
          echo ""
          echo "ğŸ“Š Variables é…ç½®çŠ¶æ€ï¼š"
          echo "  SEND_MSG: ${{ vars.SEND_MSG || 'æœªé…ç½®' }}"
          echo ""
          echo "=========================================="
          echo ""

      - name: è®¾ç½®è„šæœ¬æƒé™
        run: |
          chmod +x scripts/*.sh
          sudo cp scripts/*.sh /usr/local/bin/

      - name: å‡†å¤‡ç¯å¢ƒ
        run: prepare_env.sh

      # ==================== æ‰‹åŠ¨æ¨¡å¼ï¼ˆinit/updateï¼‰====================
      - name: è®¾ç½® SSH è°ƒè¯•ä¼šè¯
        if: github.event.inputs.mode == 'init' || github.event.inputs.mode == 'update'
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          limit-access-to-actor: false
        timeout-minutes: 60

      # ==================== è‡ªåŠ¨/æ›´æ–°æ¨¡å¼ï¼šæ¢å¤å®¹å™¨ ====================
      - name: æ¢å¤å®¹å™¨
        if: github.event.inputs.mode == 'auto' || github.event.inputs.mode == 'update'
        env:
          CONTAINER_ENCRYPTION_KEY: ${{ secrets.CONTAINER_ENCRYPTION_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: restore_from_release.sh

      # ==================== å…±åŒæ­¥éª¤ï¼šè®¾ç½®å®¹å™¨ ====================
      - name: è®¾ç½®å®¹å™¨
        run: setup_container.sh 180

      # ==================== å…±åŒæ­¥éª¤ï¼šå®‰è£… MAAã€æ¸¸æˆå’Œè¿œç¨‹è®¿é—®ï¼ˆå¹¶è¡Œï¼‰====================
      - name: å®‰è£… MAAã€æ¸¸æˆå’Œè¿œç¨‹è®¿é—®ï¼ˆå¹¶è¡Œï¼‰
        env:
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹å¹¶è¡Œå®‰è£… MAAã€æ¸¸æˆå’Œè®¾ç½®è¿œç¨‹è®¿é—®..."
          
          # åå°å¯åŠ¨ MAA å®‰è£…
          install_maa.sh > maa_install.log 2>&1 &
          MAA_PID=$!
          
          # åå°å¯åŠ¨æ¸¸æˆå®‰è£…
          install_game.sh "${{ env.CLIENT_TYPE }}" > game_install.log 2>&1 &
          GAME_PID=$!
          
          # åå°å¯åŠ¨è¿œç¨‹è®¿é—®è®¾ç½®ï¼ˆä¸¤ç§æ¨¡å¼éƒ½éœ€è¦ï¼‰
          setup_tunnel.sh > tunnel_setup.log 2>&1 &
          TUNNEL_PID=$!
          
          echo "ğŸ“¦ MAA å®‰è£…è¿›ç¨‹ PID: $MAA_PID"
          echo "ğŸ® æ¸¸æˆå®‰è£…è¿›ç¨‹ PID: $GAME_PID"
          echo "ğŸ”’ è¿œç¨‹è®¿é—®è®¾ç½®è¿›ç¨‹ PID: $TUNNEL_PID"
          echo ""
          
          # å®šæœŸæ˜¾ç¤ºè¿›åº¦ï¼ˆæ¯5ç§’ï¼‰
          while true; do
            # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
            MAA_RUNNING=$(ps -p $MAA_PID > /dev/null 2>&1 && echo "1" || echo "0")
            GAME_RUNNING=$(ps -p $GAME_PID > /dev/null 2>&1 && echo "1" || echo "0")
            TUNNEL_RUNNING=$(ps -p $TUNNEL_PID > /dev/null 2>&1 && echo "1" || echo "0")
            
            # æå– MAA å®‰è£…è¿›åº¦
            if [ "$MAA_RUNNING" == "1" ]; then
              MAA_STATUS=$(tail -1 maa_install.log 2>/dev/null | grep -oE '(ä¸‹è½½|è§£å‹|å®‰è£…|æ›´æ–°|éªŒè¯).*' | head -c 50 || echo "æ­£åœ¨å®‰è£…...")
              MAA_DISPLAY="ğŸ”„ $MAA_STATUS"
            else
              MAA_DISPLAY="âœ… å·²å®Œæˆ"
            fi
            
            # æå–æ¸¸æˆå®‰è£…è¿›åº¦
            if [ "$GAME_RUNNING" == "1" ]; then
              # å°è¯•æå–ä¸‹è½½è¿›åº¦ç™¾åˆ†æ¯”
              GAME_PROGRESS=$(tail -10 game_install.log 2>/dev/null | grep -oE '[0-9]+%' | tail -1)
              if [ -n "$GAME_PROGRESS" ]; then
                GAME_DISPLAY="â¬‡ï¸  ä¸‹è½½ä¸­ $GAME_PROGRESS"
              else
                # æ£€æŸ¥æ˜¯å¦åœ¨å®‰è£…é˜¶æ®µ
                if grep -q "å®‰è£…æˆåŠŸ\|å®‰è£…å®Œæˆ" game_install.log 2>/dev/null; then
                  GAME_DISPLAY="ğŸ”„ æ­£åœ¨å®Œæˆå®‰è£…..."
                else
                  GAME_DISPLAY="ğŸ”„ æ­£åœ¨å‡†å¤‡..."
                fi
              fi
            else
              GAME_DISPLAY="âœ… å·²å®Œæˆ"
            fi
            
            # æå–è¿œç¨‹è®¿é—®è®¾ç½®è¿›åº¦ï¼ˆç®€åŒ–æ˜¾ç¤ºï¼‰
            if [ "$TUNNEL_RUNNING" == "1" ]; then
              # æ£€æŸ¥å…·ä½“é˜¶æ®µ
              if grep -q "æ‹‰å– Cloudflare Tunnel é•œåƒ" tunnel_setup.log 2>/dev/null; then
                if grep -q "å¯åŠ¨ Cloudflare Tunnel" tunnel_setup.log 2>/dev/null; then
                  if grep -q "æ‹‰å– ws-scrcpy é•œåƒ" tunnel_setup.log 2>/dev/null; then
                    if grep -q "å¯åŠ¨ ws-scrcpy" tunnel_setup.log 2>/dev/null; then
                      TUNNEL_DISPLAY="ğŸ”„ [4/4] è¿æ¥ ADB..."
                    else
                      TUNNEL_DISPLAY="ğŸ”„ [3/4] å¯åŠ¨è¿œç¨‹æ§åˆ¶..."
                    fi
                  else
                    TUNNEL_DISPLAY="ğŸ”„ [2/4] ä¸‹è½½é•œåƒ..."
                  fi
                else
                  TUNNEL_DISPLAY="ğŸ”„ [1/4] å¯åŠ¨éš§é“..."
                fi
              else
                TUNNEL_DISPLAY="ğŸ”„ [1/4] å‡†å¤‡ç¯å¢ƒ..."
              fi
            else
              TUNNEL_DISPLAY="âœ… å·²å®Œæˆ"
            fi
            
            # æ˜¾ç¤ºè¿›åº¦
            echo "â³ [$(date '+%H:%M:%S')] å®‰è£…è¿›åº¦ï¼š"
            echo "   ğŸ“¦ MAA: $MAA_DISPLAY"
            echo "   ğŸ® æ¸¸æˆ: $GAME_DISPLAY"
            echo "   ğŸ”’ è¿œç¨‹è®¿é—®: $TUNNEL_DISPLAY"
            echo ""
            
            # æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
            if [ "$MAA_RUNNING" == "0" ] && [ "$GAME_RUNNING" == "0" ] && [ "$TUNNEL_RUNNING" == "0" ]; then
              break
            fi
            
            sleep 5
          done
          
          # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å¹¶è·å–é€€å‡ºç 
          wait $MAA_PID
          MAA_EXIT=$?
          
          wait $GAME_PID
          GAME_EXIT=$?
          
          wait $TUNNEL_PID
          TUNNEL_EXIT=$?
          
          echo "âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œæ­£åœ¨æ£€æŸ¥ç»“æœ..."
          echo ""
          
          # æ£€æŸ¥ç»“æœ
          if [ $MAA_EXIT -ne 0 ]; then
            echo "âŒ MAA å®‰è£…å¤±è´¥ (é€€å‡ºç : $MAA_EXIT)"
            echo "ğŸ“‹ MAA å®‰è£…æ—¥å¿—ï¼š"
            cat maa_install.log
            exit 1
          else
            echo "âœ… MAA å®‰è£…æˆåŠŸ"
          fi
          
          if [ $GAME_EXIT -ne 0 ]; then
            echo "âŒ æ¸¸æˆå®‰è£…å¤±è´¥ (é€€å‡ºç : $GAME_EXIT)"
            echo "ğŸ“‹ æ¸¸æˆå®‰è£…æ—¥å¿—ï¼š"
            cat game_install.log
            exit 1
          else
            echo "âœ… æ¸¸æˆå®‰è£…æˆåŠŸ"
          fi
          
          if [ $TUNNEL_EXIT -ne 0 ]; then
            echo "âš ï¸  è¿œç¨‹è®¿é—®è®¾ç½®å¤±è´¥ï¼ˆéè‡´å‘½é”™è¯¯ï¼Œé€€å‡ºç : $TUNNEL_EXITï¼‰"
            echo "ğŸ“‹ è¿œç¨‹è®¿é—®æ—¥å¿—ï¼š"
            cat tunnel_setup.log
          else
            echo "âœ… è¿œç¨‹è®¿é—®è®¾ç½®æˆåŠŸ"
          fi
          
          echo ""
          echo "ğŸ‰ MAAã€æ¸¸æˆå’Œè¿œç¨‹è®¿é—®è®¾ç½®å®Œæˆ"

      # ==================== æ‰‹åŠ¨æ¨¡å¼ï¼ˆinit/updateï¼‰ï¼šå‡†å¤‡å°±ç»ªé€šçŸ¥ ====================
      - name: å‡†å¤‡å°±ç»ªé€šçŸ¥
        if: (github.event.inputs.mode == 'init' || github.event.inputs.mode == 'update') && vars.SEND_MSG == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âœ… <b>å‡†å¤‡å·¥ä½œå·²å®Œæˆ</b>

          ğŸ“± å®¹å™¨ã€MAAã€æ¸¸æˆå·²å®‰è£…å®Œæˆ
          
          â³ <b>ä¸‹ä¸€æ­¥ï¼š</b>ç­‰å¾…ä½ æ‰‹åŠ¨ç™»å½•æ¸¸æˆ..."
          
          send_telegram.sh "${TELEGRAM_BOT_TOKEN}" "${TELEGRAM_CHAT_ID}" "${MESSAGE}"

      # ==================== æ‰‹åŠ¨æ¨¡å¼ï¼ˆinit/updateï¼‰ï¼šç­‰å¾…æ‰‹åŠ¨è®¾ç½® ====================
      - name: ç­‰å¾…æ‰‹åŠ¨è®¾ç½®
        if: github.event.inputs.mode == 'init' || github.event.inputs.mode == 'update'
        timeout-minutes: 240
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cp create_flag /usr/local/bin
          chmod +x /usr/local/bin/create_flag
          wait_manual_setup.sh "${TELEGRAM_BOT_TOKEN}" "${TELEGRAM_CHAT_ID}"

      # ==================== è‡ªåŠ¨æ¨¡å¼ï¼šè¿è¡Œ MAA ====================
      - name: è¿è¡Œ MAA
        if: github.event.inputs.mode == 'auto'
        id: run_maa
        env:
          MAA_LOG: trace
          MAA_TIMEOUT: 7200
        run: python3 run.py

      - name: ğŸ“Š å¤„ç†æŠ¥å‘Š
        if: github.event.inputs.mode == 'auto' && (steps.run_maa.outcome == 'success' || steps.fix_game_update.outcome == 'success')
        env:
          SEND_MSG: ${{ vars.SEND_MSG }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WAS_FIXED: ${{ steps.fix_game_update.outcome == 'success' }}
        run: python3 process_report.py

      - name: ğŸ“¤ å‘é€æ‰§è¡Œé€šçŸ¥
        if: github.event.inputs.mode == 'auto' && always() && vars.SEND_MSG == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MAA_TIMEOUT: 7200
          RUN_MAA_OUTCOME: ${{ steps.run_maa.outcome }}
          FIX_OUTCOME: ${{ steps.fix_game_update.outcome }}
        run: |
          if [ "${FIX_OUTCOME}" == "success" ]; then
            # ä¿®å¤åæˆåŠŸï¼šå‘é€æ‰§è¡ŒæŠ¥å‘Šï¼Œå¹¶é™„åŠ ä¿®å¤æ ‡è®°
            echo "âœ… MAA ç»è¿‡è‡ªåŠ¨ä¿®å¤åæˆåŠŸå®Œæˆ"
            WAS_FIXED="true" python3 send_msg.py
          elif [ "${RUN_MAA_OUTCOME}" == "success" ]; then
            # ç›´æ¥æˆåŠŸï¼šå‘é€æ‰§è¡ŒæŠ¥å‘Š
            echo "âœ… MAA ç›´æ¥æˆåŠŸå®Œæˆ"
            WAS_FIXED="false" python3 send_msg.py
          else
            # å¤±è´¥ï¼šå‘é€è¶…æ—¶è­¦å‘Š
            MESSAGE="âš ï¸ <b>MAA æ‰§è¡Œå¤±è´¥</b>

            âŒ MAA å·²è¶…è¿‡ ${MAA_TIMEOUT} ç§’ï¼ˆ$((MAA_TIMEOUT / 3600)) å°æ—¶ï¼‰æ²¡æœ‰æ–°çš„æ—¥å¿—è¾“å‡º
            ğŸ›‘ ä»»åŠ¡å·²è¢«è‡ªåŠ¨ç»ˆæ­¢
            ğŸ’¾ æœ¬æ¬¡ç¼“å­˜ä¸ä¼šè¢«ä¿å­˜

            â° æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
            
            ğŸ’¡ æç¤ºï¼šå¯èƒ½æ˜¯æ¸¸æˆå¡ä½æˆ– MAA é‡åˆ°æ— æ³•è¯†åˆ«çš„ç•Œé¢"
            
            send_telegram.sh "${TELEGRAM_BOT_TOKEN}" "${TELEGRAM_CHAT_ID}" "${MESSAGE}"
          fi

      # ==================== å…±åŒæ­¥éª¤ï¼šä¸Šä¼ æ—¥å¿— ====================
      - name: ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: log
          path: asst.log
          if-no-files-found: ignore

      # ==================== å…±åŒæ­¥éª¤ï¼šå¯¼å‡ºå’Œä¸Šä¼ å®¹å™¨ ====================
      - name: å¯¼å‡ºå®¹å™¨
        run: export_container.sh

      - name: ä¸Šä¼ å®¹å™¨åˆ° Release
        if: success()
        env:
          CONTAINER_ENCRYPTION_KEY: ${{ secrets.CONTAINER_ENCRYPTION_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: backup_to_release.sh

      # ==================== æ‰‹åŠ¨æ¨¡å¼ï¼ˆinit/updateï¼‰ï¼šå®Œæˆé€šçŸ¥ ====================
      - name: ğŸ“¤ åˆå§‹åŒ–å®Œæˆé€šçŸ¥
        if: (github.event.inputs.mode == 'init' || github.event.inputs.mode == 'update') && always() && vars.SEND_MSG == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="ğŸ‰ <b>åˆå§‹åŒ–å®Œæˆ</b>

            âœ… çŠ¶æ€ï¼šæˆåŠŸ
            â° æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')

            ğŸ“ <b>æç¤ºï¼š</b>ä¸‹æ¬¡å¯ä»¥ç›´æ¥è¿è¡Œè‡ªåŠ¨åŒ–ä»»åŠ¡"
          else
            MESSAGE="âŒ <b>åˆå§‹åŒ–å¤±è´¥</b>

            âš ï¸ çŠ¶æ€ï¼šå¤±è´¥
            â° æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')

            ğŸ“‹ è¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—äº†è§£è¯¦æƒ…"
          fi
          
          send_telegram.sh "${TELEGRAM_BOT_TOKEN}" "${TELEGRAM_CHAT_ID}" "${MESSAGE}"
